-- rq = {};
-- rq.GET = {};

-- rq.GET["cmd"	] = "event";
-- rq.GET["gw"	] = "192.168.1.3";
-- rq.GET["dns2"	] = "192.168.1.3";
-- rq.GET["dns1"	] = "192.168.1.3";
-- rq.GET["iface"	] = "PPP";
-- rq.GET["eventtype"] = "linkup";

-- r = {};

-- function doit()

function process()

    if     rq.GET["cmd"] == "get" then

	return (c:getNode(rq.GET["key"]):value());

    elseif rq.GET["cmd"] == "set" then

	c:getNode(rq.GET["key"]):value(rq.GET["value"]);
	return (c:getNode(rq.GET["key"]):value());

    elseif rq.GET["cmd"] == "event" then

--        if rq.GET["eventtype"] == "linkup" then

	    local iface = rq.GET["iface"];

	    if not iface then
		return ("ERROR: Interface not defined");
	    end

	    if type(r[iface]) ~= "table" then r[iface] = {}; end

	    for k,v in pairs(rq.GET) do
		if (k ~= "iface") and (k ~= "cmd") then
		    r[iface][k] = v;
		end
	    end


--	    r[iface]["eventtype"] = "linkup";
--	    r[iface]["gw"] = rq.GET["gw"] or "";
--	    r[iface]["dns1"] = rq.GET["dns1"] or "";
--	    r[iface]["dns2"] = rq.GET["dns2"] or "";

--	end

	return "OK";

    elseif rq.GET["cmd"] == "revent" then

	iface = rq.GET["iface"];

	if r[iface] then
	    return (tdump(r[iface]));
--	    return (
--		"eventtype=" .. (r[iface]["eventtype"] or "") ..
--		" gw="       .. (r[iface]["gw"       ] or "") ..
--		" dns1="     .. (r[iface]["dns1"     ] or "") ..
--		" dns2="     .. (r[iface]["dns2"     ] or ""));
	else
	    return ("ERROR: no data for interface " .. iface);
	end
    else
	return ("ERROR: unknown command");
    end
end

return ([[
<?xml version="1.0" encoding="utf-8" ?>
<data>]] ..
process() ..
[[
</data>
]]);

-- end

-- print(doit());

